<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Hula Hoop</title>
    <link rel="icon" type="image/png" href="https://files.catbox.moe/gfwkkh.png" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        * { user-select: none; -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; }
        body { margin:0; padding:0; overflow:hidden; background:#222; font-family:Arial; }
        #ui {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            width: 360px;
            z-index: 100;
            pointer-events: none;
            text-align: center;
        }
        #score {
            font-size: 28px;
            color: #fff;
            font-weight: bold;
            text-shadow: 0 0 8px #000;
            margin-bottom: 8px;
        }
        #progress-container {
            width: 100%;
            height: 22px;
            background: rgba(0,0,0,0.6);
            border: 2px solid #fff;
            border-radius: 11px;
            overflow: hidden;
        }
        #progress-bar {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, #ffeb3b, #ff9800);
            transition: width 0.1s ease;
            box-shadow: 0 0 15px #ffeb3b;
        }
        #shop-button {
            position: absolute;
            top: 50%;
            left: 20px;
            transform: translateY(-50%);
            z-index: 100;
            pointer-events: auto;
            background: #4caf50;
            color: white;
            border: none;
            padding: 14px 20px;
            font-size: 18px;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.4);
            transition: 0.2s;
            width: 60px; height: 60px;
            display: flex; align-items: center; justify-content: center;
        }
        #shop-button:hover {
            background: #45a049;
            transform: translateY(-50%) scale(1.1);
            box-shadow: 0 6px 16px rgba(0,0,0,0.5);
        }
        #shop {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 460px;
            max-height: 80vh;
            background: rgba(30,30,30,0.98);
            color: white;
            display: none;
            flex-direction: column;
            z-index: 200;
            border: 3px solid #ff9800;
            border-radius: 16px;
            box-shadow: 0 15px 40px rgba(0,0,0,0.7);
            overflow-y: auto;
            font-size: 18px;
            padding: 24px;
        }
        #shop-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            font-size: 26px;
            font-weight: bold;
            color: #ffeb3b;
        }
        #close-shop {
            background: #ff5252;
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            font-size: 22px;
            border-radius: 50%;
            cursor: pointer;
            transition: 0.2s;
            display: flex; align-items: center; justify-content: center;
        }
        #close-shop:hover {
            background: #f44336;
            transform: scale(1.1);
        }
        .upgrade {
            background: rgba(255,255,255,0.12);
            padding: 18px;
            margin: 12px 0;
            border-radius: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: 0.2s;
            border: 1px solid rgba(255,152,0,0.3);
        }
        .upgrade:hover {
            background: rgba(255,255,255,0.18);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255,152,0,0.2);
        }
        .upgrade-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .upgrade-icon {
            font-size: 36px;
            color: #ffeb3b;
        }
        .upgrade button {
            background: #ff9800;
            border: none;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            transition: 0.2s;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .upgrade button:hover:not(:disabled) {
            background: #f57c00;
            transform: scale(1.05);
        }
        .upgrade button:disabled {
            background: #666;
            cursor: not-allowed;
            opacity: 0.6;
        }
        #pause-menu {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.92); color: white;
            display: none; justify-content: center; align-items: center;
            z-index: 200; flex-direction: column; font-size: 26px;
            text-shadow: 0 0 10px #000;
        }
        #pause-menu button {
            margin: 18px; padding: 14px 28px; font-size: 20px;
            background: #ff6b6b; border: none; color: white;
            cursor: pointer; border-radius: 10px; transition: 0.2s;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }
        #pause-menu button:hover { background: #ff5252; transform: scale(1.05); }
        #reset-btn {
            background: #9c27b0 !important;
        }
        #reset-btn:hover {
            background: #7b1fa2 !important;
        }
    </style>
</head>
<body>
<div id="ui">
    <div id="score">Score: 0</div>
    <div id="progress-container">
        <div id="progress-bar"></div>
    </div>
</div>
<button id="shop-button">
    <span class="material-icons" style="font-size:28px;">shopping_cart</span>
</button>
<div id="shop">
    <div id="shop-header">
        <span>SHOP</span>
        <button id="close-shop">X</button>
    </div>
    <div class="upgrade">
        <div class="upgrade-info">
            <span class="material-icons upgrade-icon">timer</span>
            <div>
                <strong>Train Speed</strong> Lv. <span id="speed-lv">1</span><br>
                <small>Hold time: <span id="speed-val">5.0s</span> to Cost: <span id="speed-cost">10</span> pts</small>
            </div>
        </div>
        <button id="speed-upgrade">
            <span class="material-icons">upgrade</span> Upgrade
        </button>
    </div>
    <div class="upgrade">
        <div class="upgrade-info">
            <span class="material-icons upgrade-icon">star</span>
            <div>
                <strong>Score per Train</strong> Lv. <span id="score-lv">1</span><br>
                <small>Points: <span id="score-val">1</span> to Cost: <span id="score-cost">10</span> pts</small>
            </div>
        </div>
        <button id="score-upgrade">
            <span class="material-icons">upgrade</span> Upgrade
        </button>
    </div>
</div>
<div id="pause-menu">
    <div>PAUSED</div>
    <button id="resume-btn">Resume (SPACE)</button>
    <button id="reset-btn">RESET ALL DATA</button>
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>
<script>
    const pauseMenu = document.getElementById('pause-menu');
    const shop = document.getElementById('shop');
    const shopButton = document.getElementById('shop-button');
    const closeShopBtn = document.getElementById('close-shop');
    const clock = new THREE.Clock();
    const COOKIE_NAME = 'hulaHoopSave';
    const COOKIE_DAYS = 365;
    function setCookie(name, value, days) {
        const d = new Date();
        d.setTime(d.getTime() + (days * 24 * 60 * 60 * 1000));
        const expires = "expires=" + d.toUTCString();
        document.cookie = name + "=" + encodeURIComponent(JSON.stringify(value)) + ";" + expires + ";path=/";
    }
    function getCookie(name) {
        const cname = name + "=";
        const decodedCookie = decodeURIComponent(document.cookie);
        const ca = decodedCookie.split(';');
        for(let i = 0; i < ca.length; i++) {
            let c = ca[i].trim();
            if (c.indexOf(cname) === 0) {
                return JSON.parse(c.substring(cname.length, c.length));
            }
        }
        return null;
    }
    function deleteCookie(name) {
        document.cookie = name + "=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";
    }
    let baseCost = 5;
    let speedCost = baseCost;
    let scoreCost = baseCost;
    let trainTime = 5000;
    let pointsPerTrain = 1;
    let speedLevel = 1;
    let scoreLevel = 1;
    let score = 0;
    let isPaused = false;
    let isTraining = false;
    let startTime = 0;
    let canStartNewTraining = true;
    const scoreEl = document.getElementById('score');
    const progBar = document.getElementById('progress-bar');
    function loadGame() {
        const save = getCookie(COOKIE_NAME);
        if (save) {
            score = save.score || 0;
            speedLevel = save.speedLevel || 1;
            scoreLevel = save.scoreLevel || 1;
            speedCost = save.speedCost || baseCost;
            scoreCost = save.scoreCost || baseCost;
            trainTime = Math.max(1000, 5000 - (speedLevel - 1) * 800);
            pointsPerTrain = scoreLevel;
        }
        updateScoreDisplay();
        updateShopDisplay();
    }
    function saveGame() {
        const saveData = {
            score: score,
            speedLevel: speedLevel,
            scoreLevel: scoreLevel,
            speedCost: speedCost,
            scoreCost: scoreCost
        };
        setCookie(COOKIE_NAME, saveData, COOKIE_DAYS);
    }
    function resetAllData() {
        deleteCookie(COOKIE_NAME);
            score = 0;
            speedLevel = 1;
            scoreLevel = 1;
            speedCost = baseCost;
            scoreCost = baseCost;
            trainTime = 5000;
            pointsPerTrain = 1;
            isTraining = false;
            canStartNewTraining = true;
            progBar.style.width = '0%';
            updateScoreDisplay();
            updateShopDisplay();
    }
    function updateShopDisplay() {
        document.getElementById('speed-lv').textContent = speedLevel;
        document.getElementById('speed-val').textContent = (trainTime / 1000).toFixed(1) + 's';
        document.getElementById('score-lv').textContent = scoreLevel;
        document.getElementById('score-val').textContent = pointsPerTrain;
        document.getElementById('speed-cost').textContent = speedCost;
        document.getElementById('score-cost').textContent = scoreCost;
        const canSpeed = score >= speedCost;
        const canScore = score >= scoreCost;
        document.getElementById('speed-upgrade').disabled = !canSpeed;
        document.getElementById('score-upgrade').disabled = !canScore;
    }
    function upgradeSpeed() {
        if (score >= speedCost) {
            score -= speedCost;
            speedLevel++;
            trainTime = Math.max(1000, 5000 - (speedLevel - 1) * 800);
            speedCost = Math.round(speedCost * 1.1);
            updateScoreDisplay();
            updateShopDisplay();
            saveGame();
        }
    }
    function upgradeScore() {
        if (score >= scoreCost) {
            score -= scoreCost;
            scoreLevel++;
            pointsPerTrain = scoreLevel;
            scoreCost = Math.round(scoreCost * 1.1);
            updateScoreDisplay();
            updateShopDisplay();
            saveGame();
        }
    }
    function updateScoreDisplay() {
        scoreEl.textContent = 'Score: ' + score;
    }
    function closeShop() {
        shop.style.display = 'none';
    }
    document.getElementById('speed-upgrade').addEventListener('click', upgradeSpeed);
    document.getElementById('score-upgrade').addEventListener('click', upgradeScore);
    closeShopBtn.addEventListener('click', closeShop);
    shopButton.addEventListener('click', () => {
        shop.style.display = 'flex';
        updateShopDisplay();
    });
    document.getElementById('resume-btn').addEventListener('click', resumeGame);
    document.getElementById('reset-btn').addEventListener('click', resetAllData);
    document.addEventListener('keydown', e => {
        if (isPaused) {
            if (e.code === 'Space') resumeGame();
            return;
        }
        if (e.code === 'Escape') { togglePause(); return; }
        if (e.code === 'Space' && !isTraining && canStartNewTraining) {
            e.preventDefault();
            isTraining = true;
            canStartNewTraining = false;
            startTime = performance.now();
        }
    });
    document.addEventListener('keyup', e => {
        if (isPaused || e.code !== 'Space') return;
        isTraining = false;
        canStartNewTraining = true;
    });
    function togglePause() {
        isPaused = !isPaused;
        pauseMenu.style.display = isPaused ? 'flex' : 'none';
        if (!isPaused) renderer.setAnimationLoop(animate);
    }
    function resumeGame() { isPaused = false; pauseMenu.style.display = 'none'; renderer.setAnimationLoop(animate); }
    const scene = new THREE.Scene();
    scene.fog = new THREE.FogExp2(0x333333, 0.03);
    const camera = new THREE.PerspectiveCamera(75, innerWidth/innerHeight, 0.1, 1000);
    camera.position.set(0, 1.6, 0);
    scene.add(camera);
    const renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(innerWidth, innerHeight);
    renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
    renderer.shadowMap.enabled = true;
    renderer.shadowMap.type = THREE.PCFSoftShadowMap;
    document.body.appendChild(renderer.domElement);
    scene.add(new THREE.AmbientLight(0xffffff, 0.6));
    const sun = new THREE.DirectionalLight(0xffffff, 0.9);
    sun.position.set(5, 10, 5);
    sun.castShadow = true;
    sun.shadow.mapSize.set(2048, 2048);
    sun.shadow.camera.near = 0.5;
    sun.shadow.camera.far = 30;
    sun.shadow.camera.left = sun.shadow.camera.bottom = -15;
    sun.shadow.camera.right = sun.shadow.camera.top = 15;
    scene.add(sun);
    let roomModel;
    const loader = new THREE.GLTFLoader();
    loader.load(
        'RoomModel.glb',
        (gltf) => {
            roomModel = gltf.scene;
            const box = new THREE.Box3().setFromObject(roomModel);
            const size = box.getSize(new THREE.Vector3());
            const center = box.getCenter(new THREE.Vector3());
            roomModel.position.sub(center);
            roomModel.position.y += -box.min.y;
            const maxDim = Math.max(size.x, size.z);
            const scale = 18 / maxDim;
            roomModel.scale.set(scale, scale, scale);
            roomModel.position.y = 0;
            roomModel.traverse(child => {
                if (child.isMesh) {
                    child.castShadow = true;
                    child.receiveShadow = true;
                    if (child.material) {
                        child.material = new THREE.MeshLambertMaterial({
                            color: child.material.color,
                            map: child.material.map || null
                        });
                    }
                }
            });
            scene.add(roomModel);
        },
        undefined,
        () => {
            const floor = new THREE.Mesh(
                new THREE.PlaneGeometry(20, 20),
                new THREE.MeshLambertMaterial({ color: 0x8b5e3c })
            );
            floor.rotation.x = -Math.PI/2;
            floor.receiveShadow = true;
            scene.add(floor);
        }
    );
    const hoopGeometry = new THREE.TorusGeometry(0.8, 0.06, 32, 128);
    const hoopMaterial = new THREE.MeshPhongMaterial({
        color: 0xff3366,
        emissive: 0x660022,
        shininess: 100,
        specular: 0x444444
    });
    const hoop = new THREE.Mesh(hoopGeometry, hoopMaterial);
    hoop.position.set(0, 1.2, -0.5);
    hoop.rotation.x = Math.PI/2;
    hoop.castShadow = true;
    scene.add(hoop);
    const glowRing = new THREE.Mesh(
        new THREE.RingGeometry(0.75, 0.85, 64),
        new THREE.MeshBasicMaterial({ color: 0xff88aa, side: THREE.DoubleSide, transparent: true, opacity: 0.3 })
    );
    glowRing.position.copy(hoop.position);
    glowRing.rotation.x = Math.PI/2;
    scene.add(glowRing);
    const handGeometry = new THREE.SphereGeometry(0.12, 16, 16);
    handGeometry.scale(1.2, 0.8, 1.5);
    const handMaterial = new THREE.MeshPhongMaterial({
        color: 0xf4a460,
        shininess: 30
    });
    const leftHand = new THREE.Mesh(handGeometry, handMaterial);
    leftHand.position.set(-0.9, 1.2, -0.5);
    leftHand.castShadow = true;
    scene.add(leftHand);
    const rightHand = new THREE.Mesh(handGeometry, handMaterial);
    rightHand.position.set(0.9, 1.2, -0.5);
    rightHand.castShadow = true;
    scene.add(rightHand);
    function addFinger(parent, x, y, z, rotX = 0, rotZ = 0) {
        const finger = new THREE.Mesh(
            new THREE.CylinderGeometry(0.03, 0.03, 0.15),
            handMaterial
        );
        finger.position.set(x, y, z);
        finger.rotation.set(rotX, 0, rotZ);
        parent.add(finger);
    }
    addFinger(leftHand, -0.05, -0.08, -0.02, -0.3, 0.1);
    addFinger(leftHand, -0.02, -0.09, -0.01, -0.4, 0.05);
    addFinger(leftHand, 0.01, -0.09, -0.01, -0.4, 0);
    addFinger(leftHand, 0.04, -0.08, -0.02, -0.3, -0.1);
    addFinger(rightHand, 0.05, -0.08, -0.02, -0.3, -0.1);
    addFinger(rightHand, 0.02, -0.09, -0.01, -0.4, -0.05);
    addFinger(rightHand, -0.01, -0.09, -0.01, -0.4, 0);
    addFinger(rightHand, -0.04, -0.08, -0.02, -0.3, 0.1);
       
    const audioLoader = new THREE.AudioLoader();
    const listener = new THREE.AudioListener();
    camera.add(listener);
    const scoreSound = new THREE.Audio(listener);
    audioLoader.load(
        'https://files.catbox.moe/r73815.mp3',
        (buffer) => {
            scoreSound.setBuffer(buffer);
            scoreSound.setVolume(0.6);
        },
        undefined,
        (error) => console.error('Sound load error:', error)
    );
    window.addEventListener('resize', () => {
        camera.aspect = innerWidth / innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(innerWidth, innerHeight);
    });
    
    // === ENHANCED CAMERA BOBBING WITH EXTRA TRAINING INTENSITY ===
    let bobTime = 0;
    const idleBobAmplitude = 0.025;      // Gentle idle breathing
    const idleBobFrequency = 1.4;        // Slow idle bob
    const trainingBobAmplitude = 0.025;  // More intense during training
    const trainingBobFrequency = 1.4;    // Much faster during training
    const trainingExtraBobFrequency = 1.4; // EXTRA high-frequency shake for effort
    const trainingExtraBobAmplitude = 0.012;
    // === END CAMERA BOBBING VARIABLES ===
              
    function animate() {
        const delta = Math.min(clock.getDelta(), 0.1);
        const time = clock.getElapsedTime();
        if (!isPaused) {
            hoop.rotation.z += (isTraining ? 10 : 2) * delta;
            glowRing.scale.setScalar(1 + Math.sin(time * 8) * 0.05 * (isTraining ? 1 : 0.3));
            const sway = isTraining ? Math.sin(time * 12) * 0.07 : Math.sin(time * 3) * 0.02;
            const grip = isTraining ? 0.14 : 0.06;
            leftHand.position.x = -0.9 + sway + grip;
            rightHand.position.x = 0.9 - sway - grip;
            leftHand.rotation.z = sway * 2;
            rightHand.rotation.z = -sway * 2;

            // === ENHANCED CAMERA BOBBING WITH TRAINING EXTRA ===
            if (isTraining) {
                // Primary training bob (medium intensity)
                bobTime += delta * 8.2;
                let bobOffset = Math.sin(bobTime * trainingBobFrequency) * trainingBobAmplitude;
                
                // EXTRA high-frequency shake (effort/trembling feel)
                const extraShake = Math.sin(bobTime * trainingExtraBobFrequency) * trainingExtraBobAmplitude;
                bobOffset += extraShake;
                
                camera.position.y = 1.6 + bobOffset;
            } else {
                // Idle breathing
                bobTime += delta * 1.1;
                const bobOffset = Math.sin(bobTime * idleBobFrequency) * idleBobAmplitude;
                camera.position.y = 1.6 + bobOffset;
            }
            // === END ENHANCED CAMERA BOBBING ===

            if (isTraining) {
                const elapsed = performance.now() - startTime;
                const p = Math.min(elapsed / trainTime, 1);
                progBar.style.width = (p * 100) + '%';
                if (elapsed >= trainTime) {
                    score += pointsPerTrain;
                    updateScoreDisplay();
                    progBar.style.width = '0%';
                    if (scoreSound.isPlaying) scoreSound.stop();
                    scoreSound.play();
                    hoopMaterial.emissive.setHex(0xff3366);
                    setTimeout(() => hoopMaterial.emissive.setHex(0x660022), 200);
                    isTraining = false;
                    canStartNewTraining = true;
                    updateShopDisplay();
                    saveGame();
                }
            } else {
                progBar.style.width = '0%';
            }
        }
        renderer.render(scene, camera);
    }
                              
    loadGame();
    renderer.setAnimationLoop(animate);
</script>
</body>
</html>
